<% content_for :head do %>

  <!-- script src="http://maps.googleapis.com/maps/api/js?v=3.exp&libraries=places&sensor=false" type="text/javascript"></script -->

  <!-- script src="http://serverapi.arcgisonline.com/jsapi/arcgis/?v=2.8"></script -->
  <!-- script type='text/JavaScript' src="http://www.onemap.sg/API/JS?accessKEY=<%= Settings.onemap_api_key %>&v=2.8&type=full"></script -->
  <!-- script src="http://t1.onemap.sg/om_js/arcgis_js_api/library/2.8/arcgis/js/default.js" type="text/javascript"></script -->
  <!-- %= javascript_include_tag 'onemap' % -->
  <!-- link rel="stylesheet" type="text/css" href="http://t1.onemap.sg/om_js/arcgis_js_api/library/2.8/arcgis/js/dojo/dijit/themes/tundra/tundra.css"/ -->

  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/normalize/4.2.0/normalize.min.css">
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.3.1/dist/leaflet.css">

<% end %>



<div id="address" data-address="<%= address %>"><%= address %>
  <div id="mapdiv" style="width: 100%; height: 400px"></div>
</div>

<script type="text/javascript">
  (function() {
    var initMap, loadLeaflet, showBlock;

    function loadScript( url, callback ) {
      var script = document.createElement( "script" )
      script.type = "text/javascript";
      if(script.readyState) {  //IE
        script.onreadystatechange = function() {
          if ( script.readyState === "loaded" || script.readyState === "complete") {
            script.onreadystatechange = null;
            callback();
          }
        };
      } else {  //Others
        script.onload = function() {
          callback();
        };
      }

      script.src = url;
      document.getElementsByTagName( "body" )[0].appendChild( script );
    }

    loadLeaflet = function() {
      loadScript('https://unpkg.com/leaflet@1.3.1/dist/leaflet.js', function() {
        console.log('leaflet loaded, attempt to initMap');
        initMap();
      });
    };

    initMap = function() {
      var address, basemap, center, newMap;
      console.log('creating map');
      basemap = L.tileLayer('https://maps-{s}.onemap.sg/v3/Default/{z}/{x}/{y}.png', {
        detectRetina: true,
        maxZoom: 24,
        maxNativeZoom: 19,
        minZoom: 11
      });
      center = L.bounds([1.56073, 104.11475], [1.16, 103.502]).getCenter();
      // document.getElementById('mapdiv').innerHTML = "<div id='mapdiv' style='width: 100%; height: 350px;'></div>";
      $('#mapdiv').remove();
      $('#address').append("<div id='mapdiv' style='width: 100%; height: 350px;'></div>");

      newMap = L.map('mapdiv').setView([center.x, center.y], 12);
      newMap.setMaxBounds([[1.56073, 104.1147], [1.16, 103.502]]);
      basemap.addTo(newMap);
      window.map = newMap;
      // $('#mapdiv').height('350px');
      // window.map.invalidateSize();
      address = $('#address').data('address');
      showBlock(address);
    };

    function updateAddress(id, address, longlat, result) {
      $.ajax({ url: '/blocks/' + id,
        type: 'POST',
        beforeSend: function(xhr) {xhr.setRequestHeader('X-CSRF-Token', $('meta[name="csrf-token"]').attr('content'))},
        data: { id: id, address: address, longlat: longlat, geocode_result: result},
        success: function(response) {
          console.log(longlat, 'updated coords for block '+ id);
        }
      });
    }

    showBlock = function(address) {
      $.ajax({
        url: 'https://developers.onemap.sg/commonapi/search?searchVal=' + encodeURI(address) + '&returnGeom=Y&getAddrDetails=Y&pageNum=1',
        success: function(result) {
          var lat, lng, location, map, marker;
          console.log('geocoding', result);
          if (result['results'].length < 1) {
            return;
          }
          location = result['results'][0];
          lat = location['LATITUDE'];
          lng = location['LONGITUDE'];

          var longlat = lng + "," + lat;
          var id = <%= params[:id] %>;
          updateAddress(id, address, longlat, result['results']);

          map = window.map;

          if (typeof L === 'undefined') {
            console.log("loading leaflet again?!");
            loadLeaflet();
          }
          marker = new L.Marker([lat, lng], {
            bounceOnAdd: false
          }).addTo(map);
          map.setView([lat, lng], 16);
        }
      });
    };

    // prevent duplicate event handlers: https://github.com/defunkt/jquery-pjax/issues/570
    $(document).off('rails_admin.dom_ready').on('rails_admin.dom_ready', function(e) {
      var path = "<%= request.path %>";
      console.log(path, window.location.pathname, 'event:', e);

      var blockRegex = /^\/block\/[0-9]+$/;
      if (!blockRegex.test(window.location.pathname)) {
        console.log("not at block view, do nothing");
        return;
      }

      if (path != window.location.pathname) {
        console.log("event paths don't match, do nothing");
        return;
      }

      if (window.map === undefined) {
        if (typeof L === 'undefined') {
          console.log("preparing to load leaflet");
          loadLeaflet();
        } else {
          console.log("leaflet alrdy loaded, load the map");
          initMap();
        }
      } else {
        console.log("map exist..draw something?");
        // $('#mapdiv').height('350px');

        initMap();
        // window.map.invalidateSize();
      }
    });

  }).call(this);
</script>
