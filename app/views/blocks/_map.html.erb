<% content_for :head do %>

  <!-- script src="http://maps.googleapis.com/maps/api/js?v=3.exp&libraries=places&sensor=false" type="text/javascript"></script -->

  <!-- script src="http://serverapi.arcgisonline.com/jsapi/arcgis/?v=2.8"></script -->
  <!-- script type='text/JavaScript' src="http://www.onemap.sg/API/JS?accessKEY=<%= Settings.onemap_api_key %>&v=2.8&type=full"></script -->
  <!-- script src="http://t1.onemap.sg/om_js/arcgis_js_api/library/2.8/arcgis/js/default.js" type="text/javascript"></script -->
  <!-- %= javascript_include_tag 'onemap' % -->
  <!-- link rel="stylesheet" type="text/css" href="http://t1.onemap.sg/om_js/arcgis_js_api/library/2.8/arcgis/js/dojo/dijit/themes/tundra/tundra.css"/ -->

  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/normalize/4.2.0/normalize.min.css">
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.3.1/dist/leaflet.css">

  <script type="text/javascript" src="https://unpkg.com/leaflet@1.3.1/dist/leaflet.js"></script>
<% end %>



<div id="address" data-address="<%= address %>"><%= address %>
  <div id="mapdiv" style="width: 100%; height: 400px"></div>
</div>

<script type="text/javascript">
  (function() {
    var initMap, loadLeaflet, showBlock;

    loadLeaflet = function() {
      var script;
      script = document.createElement('script');
      script.type = 'text/javascript';
      script.src = 'https://unpkg.com/leaflet@1.3.1/dist/leaflet.js';
      // script.onload = 'initMap()';
      script.onreadystatechange = function() {
        if (script.readyState == 'loaded') {
          document.head.appendChild(script);
          console.log('leaflet loaded');
          initMap();
        }
      };
    };

    initMap = function() {
      var address, basemap, center, newMap;
      console.log('creating map');
      basemap = L.tileLayer('https://maps-{s}.onemap.sg/v3/Default/{z}/{x}/{y}.png', {
        detectRetina: true,
        maxZoom: 24,
        maxNativeZoom: 19,
        minZoom: 11
      });
      center = L.bounds([1.56073, 104.11475], [1.16, 103.502]).getCenter();
      // document.getElementById('mapdiv').innerHTML = "<div id='mapdiv' style='width: 100%; height: 350px;'></div>";
      $('#mapdiv').remove();
      $('#address').append("<div id='mapdiv' style='width: 100%; height: 350px;'></div>");

      newMap = L.map('mapdiv').setView([center.x, center.y], 12);
      newMap.setMaxBounds([[1.56073, 104.1147], [1.16, 103.502]]);
      basemap.addTo(newMap);
      window.map = newMap;
      // $('#mapdiv').height('350px');
      // window.map.invalidateSize();
      address = $('#address').data('address');
      showBlock(address);
    };

    showBlock = function(address) {
      $.ajax({
        url: 'https://developers.onemap.sg/commonapi/search?searchVal=' + encodeURI(address) + '&returnGeom=Y&getAddrDetails=Y&pageNum=1',
        success: function(result) {
          var lat, lng, location, map, marker;
          console.log('geocoding', result);
          if (result['results'].length < 1) {
            return;
          }
          location = result['results'][0];
          lat = location['LATITUDE'];
          lng = location['LONGITUDE'];
          map = window.map;
          console.log('invalidateSize');
          if (typeof L === 'undefined') {
            loadLeaflet();
          }
          marker = new L.Marker([lat, lng], {
            bounceOnAdd: false
          }).addTo(map);
          map.setView([lat, lng], 16);
        }
      });
    };

    $(document).on('rails_admin.dom_ready', function(e) {
      var path = "<%= request.path %>";
      console.log(path, window.location.pathname, 'event:', e);

      var blockRegex = /^\/block\/[0-9]+$/;
      if (!blockRegex.test(window.location.pathname)) {
        console.log("not at block view, do nothing");
        return;
      }

      if (path != window.location.pathname) {
        console.log("event paths don't match, do nothing");
        return;
      }

      if (window.map === undefined) {
        if (typeof L === 'undefined') {
          console.log("preparing to load leaflet");
          loadLeaflet();
        } else {
          console.log("leaflet alrdy loaded, load the map");
          initMap();
        }
      } else {
        console.log("map exist..draw something?");
        // $('#mapdiv').height('350px');
        initMap();
        // window.map.invalidateSize();
      }
    });

  }).call(this);
</script>
