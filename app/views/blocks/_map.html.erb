<% content_for :head do %>

  <!-- script src="http://maps.googleapis.com/maps/api/js?v=3.exp&libraries=places&sensor=false" type="text/javascript"></script -->

  <!-- script src="http://serverapi.arcgisonline.com/jsapi/arcgis/?v=2.8"></script -->
  <!-- script type='text/JavaScript' src="http://www.onemap.sg/API/JS?accessKEY=<%= Settings.onemap_api_key %>&v=2.8&type=full"></script -->
  <!-- script src="http://t1.onemap.sg/om_js/arcgis_js_api/library/2.8/arcgis/js/default.js" type="text/javascript"></script -->
  <!-- %= javascript_include_tag 'onemap' % -->
  <!-- link rel="stylesheet" type="text/css" href="http://t1.onemap.sg/om_js/arcgis_js_api/library/2.8/arcgis/js/dojo/dijit/themes/tundra/tundra.css"/ -->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/normalize/4.2.0/normalize.min.css">
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.3.1/dist/leaflet.css">
<% end %>

<div id="address" data-address="<%= address %>"><%= address %></div>
<div class="tundra">
  <div id="mapdiv" style="height: 400px"></div>
</div>

<script src="https://unpkg.com/leaflet@1.3.1/dist/leaflet.js"></script>
<script type="text/javascript">
  var center = L.bounds([1.56073, 104.11475], [1.16, 103.502]).getCenter();
  var map = L.map('mapdiv').setView([center.x, center.y], 12);
  var basemap = L.tileLayer('https://maps-{s}.onemap.sg/v3/Default/{z}/{x}/{y}.png', {
      detectRetina: true,
      maxZoom: 24,
      maxNativeZoom: 19,
      minZoom: 11
  });

  map.setMaxBounds([[1.56073, 104.1147], [1.16, 103.502]]);
  basemap.addTo(map);

  $.ajax({
    url: 'https://developers.onemap.sg/commonapi/search?searchVal=<%= u address %>&returnGeom=Y&getAddrDetails=Y&pageNum=1',
    success: function(result){
      console.log('geocoding', result);

      if (result['results'].length < 1) return;

      var location = result['results'][0];
      var lat = location['LATITUDE'];
      var lng = location['LONGITUDE'];

      // var popup = L.popup()
      //   .setLatLng([lat, lng])
      //   .setContent(location['ADDRESS'])
      //   .openOn(map);

      marker = new L.Marker([lat, lng], {bounceOnAdd: false}).addTo(map);
      map.setView([lat, lng], 16);
    }
  });




</script>

<%#= javascript_include_tag 'map' %>
